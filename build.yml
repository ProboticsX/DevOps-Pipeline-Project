setup: 
  - sudo apt-get update -y
  - sudo apt-get install git wget -y
  - rm -rf iTrust2-v10
  - rm -rf checkbox.io-micro-preview
  - rm -rf screenshot
  - rm -rf originalSnaps
  - sudo apt-get install -qq -y debconf-utils
  - export DEBIAN_FRONTEND="noninteractive"  
  - echo \"mysql-server mysql-server/root_password password passwd\" | sudo debconf-set-selections
  - echo \"mysql-server mysql-server/root_password_again password passwd\" | sudo debconf-set-selections
  - sudo apt-get install maven -y ; export PATH=/opt/apache-maven-3.8.4/bin:$PATH 
  - sudo apt install nodejs -y
  - sudo apt install npm -y   
  - sudo apt-get install -y nodejs jq npm imagemagick chromium-browser
  # - sudo service mysql start 
 
Variable:
  - DEBIAN_FRONTEND="noninteractive"

jobs:
  - name: itrust-build
    steps: 
      - name: install JRE
        run: sudo apt-get install default-jre -y
      - name: install JDK
        run: sudo apt-get install openjdk-11-jdk -y
      #- name: install Maven
        #run: sudo apt-get install maven -y ; export PATH=/opt/apache-maven-3.8.4/bin:$PATH 
      #- name: install nodejs
        #run: sudo apt install nodejs -y
      #- name: install npm
        #run: sudo apt install npm -y   
      - name: install mysql
        run: sudo apt-get install -y mysql-server         
      - name: create application.yml file
        run: cp iTrust2-v10/iTrust2/src/main/resources/application.yml.template iTrust2-v10/iTrust2/src/main/resources/application.yml
      - name: set password in application.yml
        run: sed -i 's/password\:/password\:\ passwd/g' iTrust2-v10/iTrust2/src/main/resources/application.yml
      - name: test iTrust1
        run: cd iTrust2-v10/iTrust2 && mvn --batch-mode --update-snapshots clean test
  - name: mutation-coverage
    iterations: 10
    steps:
      - name: clone microservice
        run: git clone microServiceGitUrl
      - name: clone Snapshot utility
        run: git clone snapshotGitUrl
      - name: copy screenshot.js
        run: cp -f /bakerx/screenshot.js  /home/vagrant/screenshot/screenshot.js
      - name: setup snapshot
        run: cd screenshot && npm i && sudo npm link
      - name: run service
        run: cd checkbox.io-micro-preview && npm install express && sudo npm install forever -g && sudo npm install escodegen && sudo npm install esprima && forever start index.js
      - name: Install libraries for snapshot utility
        run: sudo apt-get install gconf-service libasound2 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget -y
      - name: take screenshot of upload.md
        run: mkdir originalSnaps && cd originalSnaps && sudo apt-get install -y libgbm-dev && screenshot http://localhost:3000/survey/long.md ori_long && screenshot http://localhost:3000/survey/survey.md ori_survey && screenshot http://localhost:3000/survey/upload.md ori_upload && screenshot http://localhost:3000/survey/variations.md ori_variations
      - name: stop service
        run: cd checkbox.io-micro-preview && forever stop index.js
      - name: copy mutate.js
        run: cp /bakerx/mutate.js /home/vagrant/checkbox.io-micro-preview/mutate.js
      - name: Clean structure
        run: rm -rf /bakerx/mutated /home/vagrant/mutated
      - name: store mutated screenshots in the folders created 
        run: mkdir mutated && cd mutated && mkdir upload_screenshot && mkdir long_screenshot && mkdir survey_screenshot && mkdir variations_screenshot
      - name: Replace index.js
        run: cp /bakerx/checkbox-index.js /home/vagrant/checkbox.io-micro-preview/index.js
     # - name: start iterations
      
      #  run:  for i in {1..2}; do echo "Iteration $i," ; cd checkbox.io-micro-preview; node mutate.js ; forever start checkbox-index.js ; sleep 3 ;
       #       screenshot http://localhost:3000/survey/upload.md /home/vagrant/mutated/upload_screenshot/$i ; 
        #      screenshot http://localhost:3000/survey/long.md /home/vagrant/mutated/long_screenshot/$i ;
         #     screenshot http://localhost:3000/survey/survey.md /home/vagrant/mutated/survey_screenshot/$i ; 
          #    screenshot http://localhost:3000/survey/variations.md /home/vagrant/mutated/variations_screenshot/$i ; 
           #   forever stop checkbox-index.js ; cd ~ ;
            #  done 